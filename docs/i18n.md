# Internationalization (i18n) Documentation

## Overview

This FastAPI backend implements a comprehensive internationalization system that supports multiple languages with automatic language detection, cookie persistence, and pluralization support.

## Supported Languages

- **English (en)** - Default language
- **Spanish (es)**
- **French (fr)**
- **German (de)**
- **Portuguese (pt)**

## Architecture

### File Structure

```
src/common/
├── i18n.py              # Core i18n implementation
├── middleware.py        # Language detection middleware
└── locales/            # Translation files
    ├── en.json         # English translations
    ├── es.json         # Spanish translations
    ├── fr.json         # French translations
    ├── de.json         # German translations
    └── pt.json         # Portuguese translations
```

### Translation File Format

Each locale file follows this JSON structure:

```json
{
  "auth": {
    "invalid_credentials": "Invalid email or password",
    "user_not_found": "User not found"
  },
  "validation": {
    "required_field": "This field is required",
    "min_length": "Must be at least {min_length} characters"
  },
  "messages": {
    "one": "You have {count} new message",
    "other": "You have {count} new messages"
  }
}
```

## Language Detection Priority

The system uses a 4-tier priority system:

1. **Query Parameter**: `?lang=fr` (highest priority)
2. **Cookie**: `preferred_locale=es`
3. **Accept-Language Header**: Browser language preference
4. **Default**: `en` (fallback)

## Cookie Management

- **Cookie Name**: `preferred_locale`
- **Expiration**: 30 days
- **Security**: `HttpOnly`, `SameSite=lax`
- **Auto-setting**: When language is detected via query parameter

## Core Components

### i18n Class

Located in `src/common/i18n.py`

#### Key Methods

```python
# Basic translation
i18n.translate("auth.user_not_found", "es")
# Returns: "Usuario no encontrado"

# Translation with variables
i18n.translate("validation.min_length", "fr", min_length=8)
# Returns: "Doit contenir au moins 8 caractères"

# Pluralization
i18n.translate_plural("messages", 1, "de")
# Returns: "Sie haben 1 neue Nachricht"

i18n.translate_plural("messages", 5, "de")
# Returns: "Sie haben 5 neue Nachrichten"
```

#### Supported Operations

- `translate(key, language, **kwargs)` - Basic translation
- `translate_plural(key, count, language, **kwargs)` - Pluralized translation
- `get_supported_languages()` - List available languages
- `is_supported_language(lang)` - Check if language is supported
- `get_plural_form(language, count)` - Get plural form (one/other)

### Middleware

Located in `src/common/middleware.py`

The `I18nMiddleware` automatically:
- Detects user's preferred language
- Sets cookies when language is specified via query parameter
- Adds language context to all requests

### Utility Functions

Located in `src/common/utils.py`

```python
from src.common.utils import get_request_language, translate_message

# Get language from request context
language = get_request_language(request)

# Translate with automatic language detection
message = translate_message("auth.user_not_found", request)
```

## Usage Examples

### Basic Translation in Routes

```python
from fastapi import Request
from src.common.utils import translate_message

@router.post("/login")
async def login(request: Request, credentials: LoginSchema):
    user = await authenticate_user(credentials)
    if not user:
        error_message = translate_message("auth.invalid_credentials", request)
        raise HTTPException(status_code=401, detail=error_message)
    return {"message": translate_message("auth.login_success", request)}
```

### Pluralization in Routes

```python
from src.common.i18n import i18n
from src.common.utils import get_request_language

@router.get("/notifications")
async def get_notifications(request: Request):
    language = get_request_language(request)
    count = await get_notification_count()
    
    message = i18n.translate_plural("notifications", count, language)
    return {"count": count, "message": message}
```

### Error Handling with i18n

```python
from src.common.exceptions import NotFoundError
from src.common.utils import translate_message

@router.get("/users/{user_id}")
async def get_user(user_id: int, request: Request):
    user = await get_user_by_id(user_id)
    if not user:
        error_message = translate_message("auth.user_not_found", request)
        raise NotFoundError(error_message)
    return user
```

## Adding New Languages

### 1. Create Translation File

Create a new JSON file in `src/common/locales/`:

```bash
touch src/common/locales/ja.json  # Japanese
```

### 2. Add Translations

Copy the structure from `en.json` and translate all values:

```json
{
  "auth": {
    "invalid_credentials": "無効なメールアドレスまたはパスワード",
    "user_not_found": "ユーザーが見つかりません"
  },
  "messages": {
    "one": "{count}件の新しいメッセージがあります",
    "other": "{count}件の新しいメッセージがあります"
  }
}
```

### 3. Update Supported Languages

In `src/common/i18n.py`, add the new language:

```python
SUPPORTED_LANGUAGES = ['en', 'es', 'fr', 'de', 'pt', 'ja']
```

## Adding New Translation Keys

### 1. Add to English File First

In `src/common/locales/en.json`:

```json
{
  "profile": {
    "update_success": "Profile updated successfully",
    "invalid_avatar": "Invalid avatar format"
  }
}
```

### 2. Add to All Other Language Files

Translate the same keys in all other locale files.

### 3. Use in Code

```python
message = translate_message("profile.update_success", request)
```

## Pluralization Guidelines

### Supported Plural Forms

- **one**: For count = 1
- **other**: For count ≠ 1

### Adding Pluralized Keys

```json
{
  "items": {
    "one": "You have {count} item",
    "other": "You have {count} items"
  }
}
```

### Usage

```python
# Singular
message = i18n.translate_plural("items", 1, "en")
# Returns: "You have 1 item"

# Plural
message = i18n.translate_plural("items", 5, "en")
# Returns: "You have 5 items"
```

## Testing i18n

### Test Endpoints

The system includes several test endpoints:

```bash
# Basic translation test
curl "http://localhost:8000/api/v1/i18n/test?lang=es"

# Pluralization test
curl "http://localhost:8000/api/v1/i18n/pluralization?count=5&lang=fr"

# Cookie persistence test
curl -H "Cookie: preferred_locale=de" "http://localhost:8000/api/v1/i18n/test"
```

### Unit Testing

```python
import pytest
from src.common.i18n import i18n

def test_translation():
    message = i18n.translate("auth.user_not_found", "es")
    assert message == "Usuario no encontrado"

def test_pluralization():
    singular = i18n.translate_plural("messages", 1, "en")
    plural = i18n.translate_plural("messages", 5, "en")
    
    assert "1 new message" in singular
    assert "5 new messages" in plural
```

## Best Practices

### 1. Consistent Key Structure

Use hierarchical keys:
```
module.category.specific_key
```

Examples:
- `auth.validation.email_required`
- `profile.update.success`
- `payment.error.card_declined`

### 2. Variable Naming

Use descriptive variable names in translations:

```json
{
  "welcome": "Welcome back, {user_name}!",
  "pagination": "Showing {start} to {end} of {total} results"
}
```

### 3. Pluralization Variables

Always include the `{count}` variable in pluralized translations:

```json
{
  "notifications": {
    "one": "You have {count} notification",
    "other": "You have {count} notifications"
  }
}
```

### 4. Fallback Strategy

The system automatically falls back to:
1. Default language if translation not found
2. Key name if default translation not found

### 5. Error Handling

Always provide meaningful error messages in all languages:

```python
try:
    # Some operation
    pass
except SomeException:
    error_msg = translate_message("operation.failed", request)
    raise HTTPException(status_code=500, detail=error_msg)
```

## Configuration

### Environment Variables

```env
DEFAULT_LANGUAGE=en
SUPPORTED_LANGUAGES=en,es,fr,de,pt
```

### Settings

In `src/common/config.py`:

```python
class Settings:
    DEFAULT_LANGUAGE: str = "en"
    SUPPORTED_LANGUAGES: List[str] = ["en", "es", "fr", "de", "pt"]
```

## Performance Considerations

### Translation Loading

- Translations are loaded once at startup
- Files are cached in memory for fast access
- No database queries required for translations

### Middleware Overhead

- Minimal overhead for language detection
- Cookie parsing happens once per request
- Language is cached in request context

## Troubleshooting

### Common Issues

1. **Translation not found**: Check if key exists in all language files
2. **Wrong language detected**: Verify Accept-Language header format
3. **Cookie not persisting**: Check cookie settings and domain
4. **Pluralization not working**: Ensure plural keys (one/other) exist

### Debug Mode

Enable debug logging to see language detection process:

```python
import logging
logging.getLogger("i18n").setLevel(logging.DEBUG)
```

## Migration from Hardcoded Translations

If migrating from hardcoded translations:

1. Extract all hardcoded strings
2. Create appropriate keys in translation files
3. Replace hardcoded strings with `translate_message()` calls
4. Test all languages thoroughly

## API Reference

### Complete i18n Class API

```python
class I18n:
    @classmethod
    def get_supported_languages() -> List[str]
    
    @classmethod
    def is_supported_language(language: str) -> bool
    
    @classmethod
    def get_preferred_language(accept_language: str) -> str
    
    def translate(key: str, language: str = None, **kwargs) -> str
    
    def translate_plural(key: str, count: int, language: str = None, **kwargs) -> str
    
    @classmethod
    def get_plural_form(language: str, count: int) -> str
    
    @classmethod
    def get_locale_info(language: str) -> dict
```

This documentation provides a complete guide for using and extending the i18n system in your FastAPI backend.